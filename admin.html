<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CSA Gratitude Archive</title>

    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
         :root {
            --glass: rgba(255, 255, 255, .18);
            --blur: blur(26px);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }
        /* BASE */
        
        body {
            min-height: 100vh;
            background: radial-gradient(1000px 600px at top, rgba(255, 255, 255, .08), transparent 60%), linear-gradient(180deg, #050b1f, #0b2540);
            color: #fff;
            font-family: 'Playfair Display', serif;
            padding: 70px 40px;
            overflow-x: hidden;
        }
        /* SNOW */
        
        .snow {
            position: fixed;
            top: -10px;
            pointer-events: none;
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            to {
                transform: translateY(110vh)
            }
        }
        /* HEADER */
        
        .header {
            text-align: center;
            margin-bottom: 50px
        }
        
        .header h1 {
            font-size: 2.3rem;
            margin-bottom: 10px
        }
        
        .header p {
            opacity: .85;
            font-size: .95rem
        }
        /* LOGIN */
        
        #login {
            max-width: 380px;
            margin: 120px auto;
            padding: 36px 32px;
            border-radius: 28px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .22), rgba(255, 255, 255, .06));
            backdrop-filter: var(--blur) saturate(160%);
            box-shadow: 0 40px 80px rgba(0, 0, 0, .45);
            text-align: center;
            animation: fadeUp .6s ease both;
        }
        
        #login h2 {
            margin-bottom: 10px
        }
        
        #login p {
            font-size: .85rem;
            opacity: .8;
            margin-bottom: 24px
        }
        
        #login input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 16px;
            border: none;
            margin-bottom: 14px;
            font-size: 1rem;
        }
        
        #login button {
            padding: 14px 22px;
            border-radius: 18px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        /* GRID */
        
        #letters {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 36px;
        }
        /* ENVELOPE */
        
        .card-wrapper {
            position: relative;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%,
            100% {
                transform: translateY(0)
            }
            50% {
                transform: translateY(-6px)
            }
        }
        
        .envelope {
            background: linear-gradient(180deg, #ead8b8, #d6c2a0);
            border-radius: 16px;
            padding: 46px 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 18px 36px rgba(0, 0, 0, .35);
            transition: .35s ease;
            color: #5a3b23;
            position: relative;
        }
        
        .envelope::before {
            content: "";
            position: absolute;
            inset: 0 0 auto 0;
            height: 55%;
            background: linear-gradient(180deg, #d2b48c, #c3a77b);
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            border-radius: 16px 16px 0 0;
        }
        
        .envelope:hover {
            transform: translateY(-8px);
            box-shadow: 0 28px 55px rgba(0, 0, 0, .5);
        }
        
        .to-name {
            position: relative;
            z-index: 1;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .open-hint {
            font-size: .7rem;
            opacity: .6;
            margin-top: 8px;
        }
        /* LETTER */
        
        .letter {
            background: radial-gradient(circle at 20% 30%, rgba(139, 69, 19, .18), transparent 40%), radial-gradient(circle at 70% 60%, rgba(160, 82, 45, .15), transparent 45%), linear-gradient(180deg, #f5e6c8, #e6d3a3);
            color: #4b2e1e;
            padding: 30px 26px 32px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .35);
            font-family: 'Caveat', cursive;
            font-size: 1.15rem;
            line-height: 1.6;
            transform: rotate(var(--tilt));
        }
        
        .letter .to {
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 14px;
        }
        
        .date {
            margin-top: 18px;
            font-size: .75rem;
            opacity: .6;
            text-align: right;
        }
        
        .letter-content {
            display: none
        }
        
        .card-wrapper.open .envelope {
            display: none
        }
        
        .card-wrapper.open .letter-content {
            display: block;
            animation: reveal .45s ease;
        }
        
        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(14px) scale(.97)
            }
            to {
                opacity: 1;
                transform: none
            }
        }
        /* ACTION BUTTONS */
        
        .export-btn,
        .delete-btn {
            position: absolute;
            top: 10px;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: .75rem;
            cursor: pointer;
            border: none;
            opacity: .5;
        }
        
        .export-btn {
            right: 10px;
            background: rgba(90, 60, 30, .15)
        }
        
        .delete-btn {
            left: 10px;
            background: rgba(180, 40, 40, .15);
            color: #7a1f1f
        }
        
        .letter-content:hover .export-btn,
        .letter-content:hover .delete-btn {
            opacity: 1
        }
        /* ANIM */
        
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(16px)
            }
            to {
                opacity: 1;
                transform: none
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>ðŸŽ„ CSA Gratitude Archive</h1>
        <p>A quiet collection of words shared with love.</p>
    </div>

    <div id="login">
        <h2>Admin Access</h2>
        <p>This space holds gratitude. Please enter with care.</p>
        <input id="email" placeholder="Admin email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <div id="letters"></div>

    <script>
        /* FIREBASE INIT */
        firebase.initializeApp({
            apiKey: "AIzaSyAfg-H64wDdxB4NOpfSDVzY9z-iUxaT7gI",
            authDomain: "csa-christmas-gratitude.firebaseapp.com",
            projectId: "csa-christmas-gratitude"
        });
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loginBox = document.getElementById("login");
        const lettersBox = document.getElementById("letters");

        /* LOGIN */
        function login() {
            auth.signInWithEmailAndPassword(email.value, password.value)
                .catch(() => alert("Access denied"));
        }
        auth.onAuthStateChanged(user => {
            if (user) {
                loginBox.style.display = "none";
                loadMessages();
            }
        });

        /* LOAD LETTERS */
        function loadMessages() {
            lettersBox.style.display = "grid";
            db.collection("messages").orderBy("createdAt", "desc")
                .onSnapshot(snap => {
                    lettersBox.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const tilt = (Math.random() * 6 - 3).toFixed(2);
                        lettersBox.innerHTML += `
        <div class="card-wrapper" id="wrap-${doc.id}">
          <div class="envelope" onclick="openLetter('${doc.id}')">
            <div class="to-name">To: ${d.recipient}</div>
            <div class="open-hint">tap to open</div>
          </div>

          <div class="letter-content">
            <div class="letter" style="--tilt:${tilt}deg">
              <button class="delete-btn"
                onclick="event.stopPropagation(); deleteLetter('${doc.id}')">ðŸ—‘</button>

              <button class="export-btn"
                onclick="event.stopPropagation(); exportLetter('${doc.id}')">â¬‡</button>

              <div class="to">To: ${d.recipient}</div>
              <div>${d.message}</div>
              <div class="date">
                ${d.createdAt ? d.createdAt.toDate().toLocaleDateString("en-IN") : ""}
              </div>
            </div>
          </div>
        </div>`;
                    });
                    resetEnvelopes();
                });
        }

        /* OPEN LETTER */
        function openLetter(id) {
            document.getElementById(`wrap-${id}`).classList.add("open");
        }

        function resetEnvelopes() {
            document.querySelectorAll(".card-wrapper.open")
                .forEach(el => el.classList.remove("open"));
        }

        /* EXPORT LETTER */
        function exportLetter(id) {
            const letter = document.querySelector(`#wrap-${id} .letter`);
            const exportBtn = letter.querySelector(".export-btn");
            const deleteBtn = letter.querySelector(".delete-btn");

            exportBtn.style.display = "none";
            deleteBtn.style.display = "none";

            html2canvas(letter, {
                    backgroundColor: "#f5e6c8",
                    scale: 2
                })
                .then(sourceCanvas => {
                    const pad = 80;
                    const w = sourceCanvas.width + pad * 2;
                    const h = sourceCanvas.height + pad * 2;

                    const canvas = document.createElement("canvas");
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext("2d");

                    ctx.fillStyle = "#f9f4ea";
                    ctx.fillRect(0, 0, w, h);

                    ctx.drawImage(sourceCanvas, pad, pad);

                    ctx.strokeStyle = "rgba(120,90,50,.35)";
                    ctx.lineWidth = 4;
                    ctx.strokeRect(30, 30, w - 60, h - 60);

                    ctx.fillStyle = "rgba(80,50,30,.6)";
                    ctx.font = "20px 'Playfair Display', serif";
                    ctx.textAlign = "right";
                    ctx.fillText("CSA Â· Christmas Gratitude", w - 50, h - 40);

                    const a = document.createElement("a");
                    a.download = `CSA_Gratitude_${id}.png`;
                    a.href = canvas.toDataURL("image/png");
                    a.click();

                    exportBtn.style.display = "";
                    deleteBtn.style.display = "";
                });
        }

        /* DELETE LETTER */
        function deleteLetter(id) {
            if (!confirm("Are you sure you want to permanently delete this letter?")) return;
            db.collection("messages").doc(id).delete()
                .catch(() => alert("Delete failed"));
        }

        /* SNOW */
        for (let i = 0; i < 35; i++) {
            const s = document.createElement("div");
            s.className = "snow";
            s.textContent = "â„";
            s.style.left = Math.random() * 100 + "vw";
            s.style.animationDuration = (Math.random() * 6 + 4) + "s";
            s.style.opacity = Math.random();
            document.body.appendChild(s);
        }
    </script>

</body>

</html>